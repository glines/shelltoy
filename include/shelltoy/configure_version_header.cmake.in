# This file is needed in order to update the Shelltoy version at build time
# rather than at configure time. This way the qualified version string will
# reflect the latest information from git.
# Idea thanks to: <https://cmake.org/pipermail/cmake/2012-May/050095.html>

# Pass variables as they were at configure time
set(SRC_DIR "@CMAKE_SOURCE_DIR@")
set(BIN_DIR "@CMAKE_BINARY_DIR@")

# Get the version string from git
execute_process(
    COMMAND git describe --dirty
    WORKING_DIRECTORY ${CMAKE_SOURCE_DIR}
    OUTPUT_VARIABLE SHELLTOY_QUALIFIED_VERSION
    OUTPUT_STRIP_TRAILING_WHITESPACE
    )
string(REGEX MATCH
    "^[0-9]+\\.[0-9]+\\.[0-9]+"
    SHELLTOY_VERSION
    "${SHELLTOY_QUALIFIED_VERSION}"
    )
string(REGEX REPLACE
    "^([0-9]+)\\.[0-9]+\\.[0-9]+" "\\1"
    SHELLTOY_MAJOR_VERSION
    "${SHELLTOY_VERSION}"
    )
string(REGEX REPLACE
    "^[0-9]+\\.([0-9]+)\\.[0-9]+" "\\1"
    SHELLTOY_MINOR_VERSION
    "${SHELLTOY_VERSION}"
    )
string(REGEX REPLACE
    "^[0-9]+\\.[0-9]+\\.([0-9]+)" "\\1"
    SHELLTOY_PATCH_VERSION
    "${SHELLTOY_VERSION}"
    )
message("SHELLTOY_QUALIFIED_VERSION: ${SHELLTOY_QUALIFIED_VERSION}")
message("SHELLTOY_MAJOR_VERSION: ${SHELLTOY_MAJOR_VERSION}")
message("SHELLTOY_MINOR_VERSION: ${SHELLTOY_MINOR_VERSION}")
message("SHELLTOY_PATCH_VERSION: ${SHELLTOY_PATCH_VERSION}")

# Set the version strings in the Shelltoy version header 
configure_file(
    "${SRC_DIR}/include/shelltoy/version.h.in"
    "${BIN_DIR}/include/shelltoy/version.h"
    )
